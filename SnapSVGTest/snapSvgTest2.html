<!DOCTYPE html>
<html>
<style type="text/css">
	* { margin: 0; padding: 0; }
	html, body { height: 100%; width: 100%; }
	
	body
	{
		background-color: #000000;
		-moz-user-select:   none; 
	}
</style>
<script type="text/javascript" src="problems.js"></script>  	
<script type="text/javascript" src="brainPuzzle.js"></script>  
<script type="text/javascript" src="commonFuncs.js"></script>  
<script src="../SnapSVG/dist/snap.svg.js"></script>
<script type="text/javascript" > 

	var bkSvg;
	var frontSvg;
	
	var BLOCK_SIZE = 35;
	var GRID_SIZE = BLOCK_SIZE + 1;

	var INVALID_BK_COLOR = "black";
	var VALID_BK_COLOR = "grey";
	var HOVER_IN_BK_STROKE = "red";
	var HOVER_OUT_BK_STROKE = "black";

	function drawSingleGroup(group, angle, mirrorX)
	{
		var ptLen = group.points.length;
		var svgGroup = frontSvg.group();
		svgGroup.attr({
				id: group.name,
				});
		
		var org = group.points[0];
		for(var j = 0; j<ptLen; j++)
		{
			var pt = {x: group.points[j].x, y:group.points[j].y};
			
			if(mirrorX == 1)
				pt.y = -pt.y;
				
			var rpt = rotateByPoint(pt.x, pt.y, org.x, org.y, angle);
			var rect = frontSvg.rect(rpt.x*GRID_SIZE , rpt.y*GRID_SIZE , BLOCK_SIZE, BLOCK_SIZE);
			
			// By default its black, lets change its attributes
			rect.attr({
				fill: group.color,
				stroke: "blue",
				strokeWidth: 2
			});
			
			svgGroup.add(rect);
		}
		
		return svgGroup;
	}
	
	
	function drawGroups()
	{
		var len = brainPuzzleBlocks.length;
		for(var i=0; i<len; i++)
		{	
			var temp = i % 3;
			var row = (i - temp) / 3;
			var offsetX = 500 + 200 * temp;
			var offsetY = 80 + 150 * row;
			
			//alert(brainPuzzleBlocks[i].name);
			var group = brainPuzzleBlocks[i];
			var ptLen = group.points.length;
			
			var svgGroup = frontSvg.group();
			svgGroup.attr({
					id: group.name,
					});
					
			for(var j = 0; j<ptLen; j++)
			{
				var pt = group.points[j];
				var rect = frontSvg.rect(pt.x*GRID_SIZE , pt.y*GRID_SIZE , BLOCK_SIZE, BLOCK_SIZE);
				
				// By default its black, lets change its attributes
				rect.attr({
					fill: group.color,
					stroke: "blue",
					strokeWidth: 2
				});
				
				svgGroup.add(rect);
				svgGroup.attr({
						transform: 'T' + [offsetX, offsetY]
					});
			}
				
				
			var move = function(dx,dy) {
			this.attr({
						transform: this.data('origTransform') + (this.data('origTransform') ? "T" : "t") + [dx, dy]
					});
}

			var start = function() {
					this.data('origTransform', this.transform().local );
			}
			var stop = function() {
					console.log('finished dragging');
			}

				
				
				
			svgGroup.drag(move, start, stop); 
			//svgGroup.drag();
			//svgGroup.dblclick(onDbClickBlock);
		}
		//Snap("#L").remove();
	}
	
	function onDragStart(posx, posy) {
 
	}

	var currentElement = null;
	
	function onDragMove(dx, dy, posx, posy) {
		this.attr({
                    transform: this.data('origTransform') + (this.data('origTransform') ? "T" : "t") + [dx, dy]
                });
		
		var topElement = Snap.getElementByPoint(posx, posy);
		if(topElement == currentElement)
			return;
		
		
				
		if(topElement != null)
		{
			topElement.attr({strokeWidth: 5});	
			if(currentElement != null)
				currentElement.attr({strokeWidth: 2});
		}	
		
		currentElement = topElement;
/*		
	
		var col = Math.cell(posx / GRID_SIZE);
		var row = Math.cell(posy / GRID_SIZE);
		var idStr = "BkGrid_" + col + "_" + row;
		if(idStr == currentIdStr)
			return;
		else
		{
			if(currentIdStr != null)
			{
				SelectRect(currentIdStr, false);
			}
			
			SelectRect(idStr, true);
			currentIdStr = idStr;
		}*/
	}


	function onDragEnd(event)
	{
		alert(event.x + "," + event.y);
	}
	
	
	function highlightBlock(posArray, color, width) 
	{
		for(var j=0; j<posArray.length; j++)
		{
			var pos = posArray[j];
			var id = "#BkGrid_" + pos.col + "_" + pos.row;
			//var color = brainPuzzleBlocks[solutionStack[i].blockIndex].color;
			var rect = Snap(id);
			rect.attr({
				stroke: color,
				strokeWidth: width});
		}
	}
	
	function drawBlock(posArray, color) 
	{
		for(var j=0; j<posArray.length; j++)
		{
			var pos = posArray[j];
			var id = "#BkGrid_" + pos.col + "_" + pos.row;
			//var color = brainPuzzleBlocks[solutionStack[i].blockIndex].color;
			var rect = Snap(id);
			rect.attr({
				fill: color,});
		}
	}
	
	function drawSolution()
	{
		for(var i=0; i<solutionStack.length; i++)
		{
			var color = brainPuzzleBlocks[solutionStack[i].blockIndex].color;
			drawBlock(solutionStack[i].pos, color);
		}
	}
	
	function gameStart()	
	{	
		console.log('Start...');
		
		//Get all possible position
		for(var i=0; i<brainPuzzleBlocks.length; i++)
		{
			testGroupOnGrid(i);
		}
		
		console.log(resultArray);
		console.log('Find all positions ');
		
		//findSpecificSolution();
		findFirstSolutionWithoutA();
	}	

	window.onload = function() 
	{
		//初始化有效点和背景矩阵
		initValidPoints();
		BK_GRIDS = initBrainPuzzleGrids()
		//initSolution();
		
		// First lets create our drawing surface out of existing SVG element
		// If you want to create new surface just provide dimensions
		// like s = Snap(800, 600);
		bkSvg = Snap("#svgFront");
		frontSvg = Snap("#svgFront");
		
		//Draw backgroup rects
		for(var i=0; i<10; i++)
		{
			for(var j=0; j<10; j++)
			{
				//// Lets create big circle in the middle:
				var rect = bkSvg.rect(i*GRID_SIZE, j*GRID_SIZE, BLOCK_SIZE, BLOCK_SIZE);
				
				var fillColor = INVALID_BK_COLOR;
				if(BK_GRIDS[i][j] == VALID)
					fillColor = VALID_BK_COLOR;
					
				// By default its black, lets change its attributes
				rect.attr({
					id: "BkGrid_" + i + "_" + j,
					fill: fillColor,
					stroke: HOVER_OUT_BK_STROKE,
					strokeWidth: 1
				});
				
				var hoverIn = function() {
						this.attr({stroke: HOVER_IN_BK_STROKE, strokeWidth: 2});
				}
				var hoverOut = function() {
						this.attr({stroke: HOVER_OUT_BK_STROKE, strokeWidth: 1});
				}
				rect.hover(hoverIn, hoverOut);
			}
		}
		
		drawGroups();
	}
	
</script>  
</head>  
  
<body oncontextmenu="return false" onselectstart="return false" oncopy="return false">
	<svg id="svgRoot" width="100%" height="100%" style="position:absolute" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"></svg>
	<svg id="svgFront" width="100%" height="100%" style="position:absolute" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"></svg>
    <input type="button" onclick="gameStart()" style="position:absolute;left:200px;top:400px;cursor:pointer;-moz-user-select:none;-webkit-user-select:none;" value="Start find">
</body>   
</html>  